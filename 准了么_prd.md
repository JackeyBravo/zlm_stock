# 《准了么》— 股票推荐快速回测（MVP）PRD

**版本/日期**：v1.0 / 2025-11-16  
**文档目的**：指导前后端快速实现“一键回测、结果直观”的最小可行版本（不含埋点、不含海报分享）。  
**依据文件**：产品描述.md、.pdf（首页与结果页）





---

## 0. 变更摘要（相对上一版）

- **移除**：埋点与增长分析相关内容（事件、漏斗、北极星指标等）。
    
- **移除**：海报分享与相关短链/落地页（后续可作为增强项恢复）。
    
- **保留**：默认页/结果页两屏结构，三大榜单，试试手气，配额与限流。
    
    
    

---

## 1. 产品概述

- **定位**：_“准了么 | 快速验证推荐是否靠谱的工具”_（与原型一致）。
    
    
    
- **目标用户**：普通投资者、内容创作者/KOL、社群/平台运营。
    
    
    
- **核心价值**：输入“股票 + 推荐日”，一键得到**收益/年化/回撤/夏普**与**相对大盘**的可视化结果，并给出**评级**。
    
- **非目标（MVP 不做）**：分钟级/高频回测、复杂费用/滑点建模、港/美股市场、海报分享、埋点。
    
    
    

---

## 2. 范围与口径（Single Source of Truth）

- **市场范围**：A 股（沪深/科创/创业），**日线**。
    
    
    
- **执行模型**：推荐日 **T** → **T+1 开盘**买入；回测结束日 **E** → **收盘**卖出；忽略佣金/税费/滑点。
    
    
    
- **默认时窗**：起点=**当前日往回 5 个交易日**，终点=**当前日**。
    
    
    
- **基准**：默认 **沪深300**；可切换 **上证综指/中证1000**。
    
    
    
- **输入规范**：仅支持 **A 股 6 位代码**或可识别**中文名**；港/美股不在本期。
    
    
    
- **停牌/涨跌停**：按**理想成交**（开盘价），结果明细行标记 **“⚠️流动性风险”**。
    
    
    
- **配额**：游客 **3 次/天**，登录 **20 次/天**；热门榜可自由切换是否付费（本期默认免费）。
    
    
    
- **定时与榜单**：**近 10 日**为时间窗，**每日 02:00** 计算并缓存“热门/最夯/最拉”。
    
    
    
- **试试手气**：**不过滤**（从全 A 股池随机；异常降级见 §5.4）。
    
- **收费开关**：热门榜 **默认免费**；“登录后更多维度（历史/排行）”作为收费入口（仅开关占位）。
    
    
    

---

## 3. 用户路径（两屏完成）

1. **默认页（Landing）**：输入「股票名/代码，空格或换行分隔」+ 选择推荐日期 → 点击**开始回测**；页面含三榜单与“试试手气”。（见原型第 1 页）
    
    
    
2. **结果页**：展示**胜率、回测收益、年化、最大回撤、大盘收益/年化、评级**；下方为组合 vs 基准净值曲线与逐票明细。（见原型第 2 页）
    
    
    

---

## 4. 指标与算法口径

> 采用 **244 交易日/年**；**rf=0**；价格建议使用**后复权收盘价**（买入仍以不复权的 T+1 开盘价），并在页面口径说明中明确。
> 
> 

### 4.1 单票与组合收益

- 单票区间收益：`ret_i = close_E_i / open_{T+1,i} - 1`
    
- 组合收益：等权平均 `ret = mean(ret_i)`
    
- 交易日数：`N` 为 `[T+1, E]` 的交易日个数（含首尾）。
    

### 4.2 年化与超额

- 年化收益：`ann = (1 + ret)^(244 / N) - 1`
    
- 基准收益：同区间指数收盘序列计算。
    
- 区间超额：`excess = (1 + ret) / (1 + ret_bench) - 1`
    
- 超额年化：`excess_ann = (1 + excess)^(244 / N) - 1`
    

### 4.3 风险指标

- 日收益序列（组合）：持有期等权聚合的 `r_d`。
    
- 夏普（年化）：`Sharpe = mean(r_d) / std(r_d) * sqrt(244)`（`rf=0`）。
    
- 最大回撤（MDD）：对 `cum = cumprod(1 + r_d)` 计算峰-谷最大跌幅（返回负值）。
    
- 卡尔玛：`Calmar = ann / |MDD|`（`|MDD|=0` 时显示 “—”）。
    

### 4.4 评级（五档）

- 综合评分：  
    `Score = 0.5 * Z(excess_ann) + 0.3 * Z(Sharpe) - 0.2 * Z(|MDD|)`
    
    > 在**同一参考集合**内做 Z-score：优先使用“本次输入集合”；若样本 <5，则回退到近 180 天全站分布（实现可先简化为“始终本次集合”）。
    
- 分档映射（高→低）：**夯 / 顶级 / 人上人 / NPC / 拉完了** = **10% / 20% / 40% / 20% / 10%**。原型右侧“回测评级”示意沿用该排序与配色。
    
    
    
- 胜率：一次回测中“收益>0”的个股占比。
    
    
    

---

## 5. 功能需求

### 5.1 默认页

- **输入框**：多行输入；支持中文名/6位代码；空格或换行分隔；无效代码提示。
    
    
    
- **推荐日期**：默认=当天（文案提示“次日开盘买入”）。
    
- **按钮**：**开始回测**、**试试手气**。
    
- **榜单区**：**近10日热门回测/最夯回测/最拉回测**（点击带参跳结果页）。布局与标题严格参考原型第 1 页。
    
    
    
- **配额提示**：展示“游客3次/天；登录20次/天”。
    
    
    

### 5.2 结果页

- 顶部指标卡：**胜率、回测收益、回测年化、最大回撤、大盘收益、大盘年化**；右侧为**回测评级**（五档彩色）。
    
    
    
- 中部图表：组合 vs 基准**累计收益曲线**（起点归一为 1），hover 显示日期/组合/基准。
    
- 明细表字段：  
    `code | name | buy_date | buy_price | sell_date | sell_price | ret | excess | ann | sharpe | mdd | calmar | grade | flags`
    
    - `flags`：如 `["LIQ_RISK"]`；当停牌/涨跌停/无开盘价顺延时添加。
        
        
        
- **口径说明**（页脚/弹层）：T+1 开盘买、E 收盘卖、忽略费用、后复权口径、rf=0、年化=244、理想成交假设、非投资建议 & 数据来源 AKShare。
    
    
    

### 5.3 榜单（近 10 日，02:00 重算）

- **热门回测**：按“被回测次数”排序（同用户+同股票+同推荐日去重）。
    
- **最夯回测**：按“综合评分均值”或“高评级计数”排序取 Top N。
    
- **最拉回测**：按“平均超额最低/回撤最大”取 Bottom N。
    
- **免费策略**：**热门榜默认免费**；“登录后更多维度（历史/排行）”作为收费入口（仅开关）。
    
    
    
    
    

### 5.4 试试手气（不过滤）

- **抽样池**：全 A 股代码表。
    
- **降级策略**：随机到无近端行情/长期停牌 → 自动**重抽**；若 T+1 无开盘价 → **顺延至下一交易日**成交并打标“⚠️延迟成交”。
    
- **触发后**：直接进入回测页并显示结果（无额外参数选择）。
    
    
    

### 5.5 账号、配额与限流

- **配额**：游客 3 次/天、登录 20 次/天；命中缓存不计次（按参数指纹）。
    
    
    
- **限流**：**IP + 账号** 双重；超限返回 `429` 并弹层引导“去登录/开通”。
    

---

## 6. 非功能性要求

- **性能**：P95 ≤ 3s/票（单票计算）；榜单接口命中缓存响应 < 300ms。
    
- **可用性**：移动端无横向滚动；异常/空态文案完整（无效代码、非交易日、样本太短等）。
    
- **稳定性**：榜单重算失败自动重试；数据缺口降级不影响页面渲染。
    

---

## 7. 系统设计（简要）

### 7.1 技术栈与架构

- 前端：Next.js 或 Vite+React（两页结构）。
    
- 后端：Python + FastAPI；缓存 Redis；DB：PostgreSQL（MVP 可 SQLite）。
    
- 定时任务：APScheduler/Celery Beat 在 **02:00** 跑“近 10 日”三榜。
    
    
    

### 7.2 数据源

- AKShare（A 股/指数日线、交易日历、代码-名称映射）。在页面口径披露 **数据来源** 与 **非投资建议**。
    
    
    

### 7.3 API（MVP）

1. `POST /api/backtest`  
    **入参**：
    
    `{   "stocks": ["平安银行", "601318", "000001"],   "recommend_date": "YYYY-MM-DD",   "end_date": null,   "benchmark": "HS300|SSE|CSI1000",   "price_adjust": "post" }`
    
    **出参（节选）**：
    
    `{   "bt_id": "string",   "window": {"start":"2025-11-10","end":"2025-11-17","trading_days":6},   "benchmark": "HS300",   "summary": {     "win_rate": 0.67,     "ret": 0.052,     "ann": 0.48,     "bench_ret": -0.013,     "bench_ann": -0.11,     "excess": 0.066   },   "equity": [{"date":"2025-11-11","portfolio_nv":1.012,"bench_nv":0.998}],   "items": [{     "code":"000001","name":"平安银行",     "buy_date":"2025-11-11","buy_price":10.23,     "sell_date":"2025-11-17","sell_price":10.74,     "ret":0.0498,"excess":0.062,"ann":0.47,     "sharpe":1.21,"mdd":-0.07,"calmar":6.7,     "score":0.88,"grade":"顶级","flags":["LIQ_RISK"]   }] }`
    
2. `GET /api/backtest/{bt_id}` —— 复现回测结果（用于刷新/复制参数）。
    
3. `GET /api/rank/hot?days=10&limit=20` —— 近 10 日**热门回测**。
    
4. `GET /api/rank/best?days=10&k=5&limit=20` —— 近 10 日**最夯回测**（样本阈值 `k`）。
    
5. `GET /api/rank/worst?days=10&k=5&limit=20` —— 近 10 日**最拉回测**。
    
6. `GET /api/random?date_mode=auto` —— **试试手气**（不过滤，内部重抽/顺延）。
    
7. `GET /api/quota` —— 当日剩余额度、是否已登录、限流状态。
    

**错误码**：  
`400_INVALID_TICKER`、`400_UNSUPPORTED_MARKET`、`422_DATE_OUT_OF_RANGE`、`422_INSUFFICIENT_DATA`、`429_QUOTA_EXCEEDED`、`500_INTERNAL_ERROR`。

### 7.4 数据库（简表）

- `stocks(code PK, name, exchange, status_tags)`
    
- `quotes_daily(code, date, open, close, adj_close, flags)`
    
- `backtest(bt_id PK, user_id, start, end, benchmark, summary_json, created_at)`
    
- `backtest_item(id PK, bt_id FK, code, buy_date, buy_price, sell_date, sell_price, ret, excess, ann, sharpe, mdd, calmar, score, grade, flags)`
    
- `rank_snapshot(date, type ENUM['hot','best','worst'], payload)`
    
- `user(id PK, plan, quota_day_used, created_at)`
    
- `feature_flag(key PK, value, enabled)`
    

---

## 8. UI 文案（关键）

- **主标题**：**准了么｜快速验证推荐是否靠谱的工具**（首页/结果页）。
    
    
    
- **输入占位**：**回测股票名称或者代码，空格或者换行分割**。
    
    
    
- **指标卡**：**胜率统计 / 回测收益 / 回测年化 / 最大回撤 / 大盘收益 / 大盘年化**。
    
    
    
- **评级**：**夯 / 顶级 / 人上人 / NPC / 拉完了**（颜色与示意同原型右侧“回测评级”）。
    
    
    
- **口径披露**（页脚）：**T+1 开盘买入、期末收盘卖出；忽略费用；后复权口径；rf=0；年化=244；理想成交假设；数据来源 AKShare；非投资建议。**
    
    
    

---

## 9. 合规与风险

- **免责声明**：仅供学习与交流，非投资建议；盈亏自负。
    
    
    
- **数据来源**：AKShare（免费公开数据接口），不对其稳定性作保证。
    
    
    
- **风控**：IP+账号限流；榜单防刷（同参去重、最小样本阈值）；异常行为黑名单。
    

---

## 10. 测试与验收

- **正确性**：随机抽样 20 只股票核对 `Open_{T+1}` 与 `Close_E`、收益、年化（244）、夏普、MDD、Calmar；胜率=收益>0 比例。
    
    
    
- **分档**：在参考集合内，评级分布满足 10/20/40/20/10（四舍五入取整）。
    
- **边界**：
    
    - 非交易日作为推荐日 → 自动顺延至下一个交易日；
        
    - T+1 无开盘价 → 顺延卖/买点并加 “⚠️延迟成交”；
        
    - 试试手气抽中停牌/ST/退市预警 → 走重抽或顺延，并在明细打标。
        
- **性能**：单次请求 ≤ 50 票，P95 ≤ 3s/票；榜单接口命中缓存 < 300ms。
    
- **可用性**：移动端适配通过；表格字段不折行错位。
    

---

## 11. 里程碑

- **M1（后端可跑）**：数据接入、交易日历、回测计算（收益/年化/夏普/MDD/Calmar/超额）、评分与评级、API。
    
- **M2（端到端）**：默认页 + 结果页实现、三榜单（近10日 02:00 跑批）、试试手气（不过滤 + 降级）。
    
    
    
- **M3（后续增强，非本期）**：海报分享、落地页面、埋点与增长分析、登录后更多维度（历史/排行）计费化。
    
    
    

---

## 12. 配置与特性开关（默认值）

|Key|说明|默认|
|---|---|---|
|`rank.window_days`|榜单时间窗|`10`|
|`rank.recompute_time`|跑批时间|`02:00`|
|`score.weights`|评分权重（ExcessAnn/Sharpe/MDD）|`0.5/0.3/-0.2`|
|`annual.trading_days`|年化折算天数|`244`|
|`risk_free_rate`|rf|`0`|
|`try_luck.filter`|试试手气过滤|`off`（不过滤）|
|`quota.guest_per_day`|游客日配额|`3`|
|`quota.login_per_day`|登录日配额|`20`|
|`rank.hot.free`|热门榜是否免费|`true`|
|`ui.rating.label_mid`|第三档文案|`人上人`（可切换“股上股”）|

---

### 附件对齐说明

- **页面与交互结构**（默认页输入、三榜、试试手气、结果页指标与评级表）：见 _原型.pdf 第1–2页_。
    
    
    
- **业务口径、输入范围、评估指标、配额与收费位、默认起止、合规声明**：见 _产品描述.md_。
    
    