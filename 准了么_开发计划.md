# 准了么（V1.0）开发计划

## 1. 目标与范围
- **定位**：一款面向普通投资者与投研从业者的「推荐验证」小工具，可快速检验单只或多只股票在指定日期后的收益表现。
- **MVP 范围**：支持 A 股股票回测，提供收益/风险核心指标、评级分层、随机推荐及热门榜单。前端基于 Vite+React，后端使用 FastAPI，数据源来自同花顺/AKShare。
- **策略说明**：默认以推荐日次日开盘买入、结束日收盘卖出；基准指数可选沪深 300、上证指数、中证 1000；指标按 244 个交易日进行年化。

## 2. 技术架构
| 层级 | 方案 | 备注 |
| --- | --- | --- |
| 前端 | Vite + React + React Router + SWR | 双页结构（默认页、回测页），含表单、榜单、评级展示。 |
| 后端 | FastAPI + Uvicorn | 暴露 `backtest`、`rank`、`random`、`quota` 等接口。 |
| 数据层 | SQLite/PostgreSQL + Redis | 行情与回测结果持久化，配额、榜单缓存。 |
| 调度 | 自研脚本 + 计划任务 | 02:00 重新计算榜单、同步行情。 |
| 数据源 | 同花顺 K 线接口 + AKShare 股票列表 | 无法访问东财时改走 THS。 |
| 观察性 | 结构化日志 + 计划中的 Prometheus/Sentry | 监控夜间任务与接口错误。 |

## 3. 里程碑
| 阶段 | 周期 | 交付物 | 当前状态 |
| --- | --- | --- | --- |
| **M0 环境搭建** | Week 0 | 仓库初始化、CI 雏形、AKShare 连通性 | ✅ 完成 |
| **M1 数据 & 回测引擎** | Weeks 1-3 | 行情入库、指标计算、Backtest API、Quota 逻辑 | ✅ 核心完成 |
| **M2 前端体验 & 调度** | Weeks 4-6 | 默认页/回测页、榜单 API、02:00 调度、观测告警 | ⏳ 进行中（前端布局在调） |
| **M3 增强 & 商业化** | Weeks 7-9 | 登录/付费预留、历史榜单、导出、监控完善 | ⏳ 尚未启动 |

## 4. 阶段进展

### M0 环境准备（已完成）
- [x] 统一仓库结构（`frontend/` `backend/` `infra/`），配置 ESLint/ Ruff。
- [x] 提供 docker-compose（FastAPI + Redis + Postgres + 前端）。
- [x] 验证 AKShare/同花顺接口连通性，编写最小脚本。
- [x] 输出 `.env.sample` 与密钥管理策略。

### M1 数据 & 回测（核心完成）
1. **行情与元数据**
   - [x] 同步 `stocks`、`quotes_daily` 表结构，可标记停牌/风险标签。
   - [x] 当东财不可用时自动切换同花顺接口，支持在线补行情。
2. **指标计算**
   - [x] 完整实现收益、年化、超额、Sharpe、MDD、Calmar、胜率等指标。
   - [x] 依据 PRD 配置 Z-Score 权重和五档评级（夯/顶级/人上人/NPC/拉完了）。
3. **Backtest API 套件**
   - [x] `POST /api/backtest` 校验输入、调用引擎、持久化 `bt_id`。
   - [x] `GET /api/backtest/{bt_id}` 读取数据库/缓存复用结果。
4. **榜单/随机与配额**
   - [x] `quota:{date}:{ip}-{visitor}` 结构实现 3/20 次限额。
   - [x] 夜间脚本支持剔除停牌/ST、生成热门/最夯/最拉榜单、随机列表。
5. **质量保障**
   - [ ] 单元/集成测试（计划在下一迭代补齐，当前以手测为主）。
   - [ ] 性能校准（目标：50 只股票 P95 ≤3s，API P95 <300ms，待压测）。

### M2 前端体验 & 调度（进行中）
- 默认页：表单 + 榜单布局已对齐原型，正在打磨样式与骨架屏。
- 回测页：核心指标、评级面板、权益曲线占位、回测明细已完成；图表、导出功能将在本阶段后期补全。
- 调度：02:00 任务脚本已可手动触发，需接入系统级计划任务与失败告警。
- 观测：结构化日志已接通，Prometheus/Sentry 还未落地。

### M3 增强（待启动）
- 账号体系：计划引入 Keycloak/Ory，支持游客/登录配额切换。
- 历史榜单、导出、分享链接、调仓记录等增强功能保留在产品 backlog 中。
- 监控与运维：构建蓝绿发布、数据修复脚本、收费策略等。

## 5. 跨阶段工作
- **CI/CD**：GitHub Actions（Lint/Test/Build）已配置基础流程，部署环节待接入。
- **安全**：AKShare/THS 凭证统一存放，HTTPS/限流策略已落实。
- **协作**：以 Issues + 周会跟踪，确保需求/缺陷有入口。
- **文档**：PRD、API Schema、回测公式、前端交互稿定期同步，避免多版本。

## 6. 风险与应对
| 风险 | 影响 | 应对措施 |
| --- | --- | --- |
| 外部行情接口不稳定 | 夜间任务失败、回测缺数据 | 增加重试、缓存、备用数据源；必要时人工补数。 |
| 指标计算性能不足 | 回测接口超时 | 批量行情缓存、异步计算、热点回测缓存命中。 |
| 滥用/刷配额 | 服务成本上升、体验变差 | IP+Visitor 双键限流，后续接入账号体系。 |
| 前端体验偏离原型 | 用户理解成本高 | 根据原型定期 UI Review，前后端联调时即时调整。 |
| 观察性不足 | 故障定位慢 | M2 内补齐日志、指标、告警链路。 |

## 7. 下一步计划
1. **完成 M2**：对齐回测页/默认页所有视觉细节，补齐榜单调度与告警。
2. **补测试**：为回测引擎、API、Hooks 编写单元/集成测试，用于回归。
3. **性能校准**：构造 50 只股票、不同窗口的压测场景，记录 P95 指标。
4. **准备 M3 需求**：梳理登录/导出/历史榜单等详细实现方案，拆分故事点。

> 当前文件已统一为 UTF-8 编码，可直接在 VS Code/Notepad++ 中正常显示。如需查看历史版本，请查阅 Git 提交记录。
