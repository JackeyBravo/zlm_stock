# 准了么（V1.0）开发计划

## 1. 目标与范围
- 依据《准了么_prd.md》与原型图，交付一款验证股票推荐可靠性的 Web 工具，覆盖默认页（Landing）与回测页（Results）两大入口。
- MVP 范围：A 股股票回测引擎、榜单/随机推荐、配额控制、Vite+React 前端、FastAPI 后端、02:00 调度任务、Redis + PostgreSQL/SQLite 数据栈。
- 限制条件：无现成账号系统，先用 “IP + 临时访客标识” 控制配额，后续可接入开源 IAM（Keycloak/Ory 等）。

## 2. 技术与架构基线
| 层级 | 方案 | 备注 |
| --- | --- | --- |
| 前端 | Vite + React SPA、React Router、SWR | 负责表单、榜单、回测展示与披露。 |
| 后端 | FastAPI、Uvicorn | 提供 `backtest`、`rank`、`random`、`quota` API。 |
| 数据 | PostgreSQL（MVP 可 SQLite）、Redis | 行情、回测结果、榜单快照、配额计数。 |
| 调度 | APScheduler/Celery Beat | 每日 02:00 更新榜单 & 随机池。 |
| 第三方 | AKShare | A 股行情、指数数据源。 |
| 观察 | Prometheus/Grafana 或 Sentry/ELK | 监控调度、接口性能、配额异常。 |

## 3. 里程碑总览
| 里程碑 | 计划周期 | 核心输出 | 关键依赖 |
| --- | --- | --- | --- |
| M0：环境准备 | Week 0 | 仓库初始化、CI/CD 雏形、AKShare 访问验证 | 开发机、VPN/代理、AKShare 账号 |
| M1：数据与引擎 | Weeks 1-3 | 行情落库、指标计算、`POST /api/backtest`、配额底座、试手气候选池 | AKShare 稳定性、数据库 |
| M2：产品体验 | Weeks 4-6 | Vite SPA 双页面、榜单&随机 API、02:00 调度上线、披露模块、观测面板 | M1 API / 数据、Redis |
| M3：商业化拓展 | Weeks 7-9 | 登录集成预留、历史榜单回放、导出/分页、监控告警完整化、付费策略钩子 | M2 UI/服务、开源 IAM |

## 4. 详细拆分所选股票区间缺少行情数据

### M0：环境与基建（Week 0）
- [x] 建立 Mono Repo（`frontend/`、`backend/`、`infra/` 目录）与 Git 工作流，配置基础 lint/format。
- [x] Docker Compose 定义：FastAPI + Redis + PostgreSQL + 前端 Dev Server。
- [x] 申请/验证 AKShare 访问，编写最小脚本落地到本地数据库。
- [x] 生成 `.env.sample`、Secrets 管理策略。

### M1：数据 & 回测引擎（Weeks 1-3）
1. **行情与元数据**
   - 股票基础表 `stocks`、日线行情 `quotes_daily`、指数行情同步作业，落库并补齐停牌/ST 标记。
   - 数据质量校验：缺口补齐、T+1 开盘价可用性、异常波动报警。
2. **指标计算服务**
   - 实现回测公式（收益/年化/超额/Sharpe/MDD/Calmar/胜率），并对多只股票算术平均。
   - Z-Score 打分与评级映射（10/20/40/20/10 权重），处理数据量 <5 的兜底逻辑。
3. **Backtest API 套件**
   - `POST /api/backtest`：参数校验、合规股票过滤、bt_id 生成、结果持久化。
   - `GET /api/backtest/{bt_id}`：回查缓存/数据库，供前端刷新。
4. **配额与随机底座**
   - Redis 结构：`quota:{date}:{ip}-{visitorId}`；配额逻辑（游客 3 次/天、临时访客 20 次/天）。
   - “试试手气”候选池生成脚本：剔除停牌/ST/无行情股票，仅保留近期可交易标的。
5. **质量保障**
   - 单元测试覆盖公式、配额、API Schema；集成测试模拟 20 支股票回测。
   - 性能基线：50 股票 P95 ≤3s；API P95 <300ms。

### M2：前端体验 & 夜间任务（Weeks 4-6）
1. **Vite SPA**
   - 默认页：多行输入解析、日期选择、按钮状态、配额提示、榜单卡片占位。
   - 回测页：指标卡片、权益曲线（ECharts/Recharts）、表格（排序/筛选）、方法论 Disclosure。
   - 状态管理：SWR + 自定义 Hook 处理 loading/error；全局 Toast/Modal。
2. **榜单与随机 API**
   - `/api/rank/hot|best|worst`：读取 `rank_snapshot`，支持查询参数 days/k/limit。
   - `/api/random`：从候选池随机抽取，附带 flags、榜单标签、可直接跳回测。
3. **02:00 调度**
   - APScheduler/Celery Beat：拉取最新行情、重算榜单、填充随机池；失败自动重试。
   - 指标 &榜单结果写入 `rank_snapshot`，同时回推监控事件。
4. **观测与告警**
   - 接入日志/指标：调度成功率、AKShare 拉取耗时、API 错误分布、配额触顶情况。
   - 夜间失败通知（Slack/钉钉 Webhook）。
5. **前后端联调**
   - Swagger + Mock 数据驱动前端联调；完成 e2e 测试（Playwright/Cypress）覆盖主流程。

### M3：增强与商业化（Weeks 7-9）
1. **账号/付费预留**
   - 选型并部署开源 IAM（推荐 Keycloak）；实现 OIDC 登录、用户表扩展、配额迁移。
   - Feature Flag：控制热门榜是否对游客开放、是否开启收费策略。
2. **功能增强**
   - 历史榜单回放、榜单导出（CSV/Excel）、表格分页/排序持久化。
   - 回测结果分享链接、截图导出、批量导入股票列表。
3. **可观测性强化**
   - 更细粒度的业务指标（成功回测数、榜单命中率）。
   - 混沌演练/回滚脚本、数据修复工具。
4. **运维与交付**
   - 生产部署 Pipeline（Docker 镜像 → K8s/Server），蓝绿发布、自动化备份。
   - 文档化：Runbook、FAQ、数据口径说明。

## 5. 跨阶段工作
- **CI/CD**：GitHub Actions/GitLab CI，执行 lint/test/build/docker push，预发环境自动部署。
- [x] **安全**：AKShare 凭证加密存储，API 限流、防刷策略、HTTPS 强制。
- **协作**：每周例会同步风险，需求/缺陷管理使用 Issue + 看板。
- **文档**：接口文档（OpenAPI）、SQL 迁移、调度任务说明、用户操作手册。

## 6. 风险与应对
| 风险 | 影响 | 对策 |
| --- | --- | --- |
| AKShare 接口不稳定 | 数据缺失、夜间任务失败 | 增加重试 + 缓存；必要时接入备用数据源。 |
| 指标计算性能不足 | 回测响应超出 3s | 启用批量查询、向量化（Pandas/Polars），热点结果缓存。 |
| 配额绕过 | 成本或滥用 | IP + Visitor 双键、User-Agent 指纹、节流中间件。 |
| 无账号系统 | 难以区分用户层级 | M3 集成 Keycloak，当前阶段保留接口/表结构，便于平滑迁移。 |
| 前端体验欠佳 | 用户流失 | 引入设计评审、A/B 验证、组件库复用（AntD/Arco）。 |

## 7. 下一步
1. 确认团队人员配置与里程碑日期，立项 M0。
2. 依据本计划创建迭代 Backlog/Issue，并定义验收标准。
3. 启动环境准备与 AKShare 连通性验证。




600127